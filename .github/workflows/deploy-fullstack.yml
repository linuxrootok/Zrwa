name: CD - Deploy Fullstack App

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '*.md'
      - 'README*.md'
      - '.gitignore'
  workflow_dispatch:

env:
  APP_INSTANCE_NAME: fullstack-app
  DB_INSTANCE_NAME: fullstack-db
  REGION: us-east-1
  SSH_USER: ec2-user

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/lightsail-keypair.pem
        chmod 600 ~/.ssh/lightsail-keypair.pem
        
        # 验证必需的 secrets 是否已配置
        if [ -z "${{ secrets.APP_INSTANCE_IP }}" ]; then
          echo "❌ 错误: APP_INSTANCE_IP secret 未配置"
          exit 1
        fi
        
        if [ -z "${{ secrets.DB_INSTANCE_IP }}" ]; then
          echo "❌ 错误: DB_INSTANCE_IP secret 未配置"
          exit 1
        fi
        
        # 添加主机到 known_hosts（可选，因为使用了 StrictHostKeyChecking=no）
        if [ -n "${{ secrets.APP_INSTANCE_IP }}" ]; then
          ssh-keyscan -H ${{ secrets.APP_INSTANCE_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true
        fi
        
        if [ -n "${{ secrets.DB_INSTANCE_IP }}" ]; then
          ssh-keyscan -H ${{ secrets.DB_INSTANCE_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true
        fi
    
    - name: Build backend WAR
      run: |
        cd backend
        mvn clean package -DskipTests
        echo "✅ Backend WAR built"
    
    - name: Build frontend
      run: |
        cd frontend
        npm install
        npm run build
        echo "✅ Frontend built"
    
    - name: Deploy database server
      run: |
        echo "=== Deploying Database Server ==="
        
        # 确保 Docker 和 Docker Compose 已安装并运行
        ssh -i ~/.ssh/lightsail-keypair.pem \
          -o StrictHostKeyChecking=no \
          ${{ env.SSH_USER }}@${{ secrets.DB_INSTANCE_IP }} << 'EOF'
          # 检查并安装 Docker
          if ! command -v docker &> /dev/null; then
            echo "安装 Docker..."
            sudo yum update -y
            sudo yum install -y docker
            sudo systemctl start docker
            sudo systemctl enable docker
            echo "✅ Docker 安装完成"
          else
            echo "✅ Docker 已安装"
            # 确保 Docker 服务正在运行
            sudo systemctl start docker || true
            sudo systemctl enable docker || true
          fi
          
          # 将 ec2-user 添加到 docker 组（避免需要使用 sudo）
          if ! groups | grep -q docker; then
            sudo usermod -aG docker ec2-user
            echo "⚠️  注意: 已添加到 docker 组，但需要重新登录才能生效"
          fi
          
          # 检查 Docker 是否运行
          if ! sudo docker ps &> /dev/null; then
            echo "启动 Docker 服务..."
            sudo systemctl start docker
            sleep 3
          fi
          
          # 验证 Docker 运行
          if sudo docker ps &> /dev/null; then
            echo "✅ Docker daemon 正在运行"
          else
            echo "❌ 错误: Docker daemon 未运行"
            sudo systemctl status docker
            exit 1
          fi
          
          # 检查并安装 Docker Compose
          if ! command -v docker-compose &> /dev/null && [ ! -f /usr/local/bin/docker-compose ]; then
            echo "安装 Docker Compose..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            echo "✅ Docker Compose 安装完成"
          else
            echo "✅ Docker Compose 已安装"
          fi
          
          # 验证 Docker Compose
          COMPOSE_CMD=$(command -v docker-compose 2>/dev/null || echo "/usr/local/bin/docker-compose")
          $COMPOSE_CMD version || sudo $COMPOSE_CMD version || echo "警告: 无法验证 Docker Compose 版本"
        EOF
        
        # Upload database configuration
        scp -i ~/.ssh/lightsail-keypair.pem \
          -o StrictHostKeyChecking=no \
          docker-compose.db.yml \
          database/init.sql \
          ${{ env.SSH_USER }}@${{ secrets.DB_INSTANCE_IP }}:/home/ec2-user/
        
        # Create .env file and start services
        ssh -i ~/.ssh/lightsail-keypair.pem \
          -o StrictHostKeyChecking=no \
          ${{ env.SSH_USER }}@${{ secrets.DB_INSTANCE_IP }} << 'EOF'
          cat > /home/ec2-user/.env << EOL
        MYSQL_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}
        MYSQL_DATABASE=${{ secrets.DB_NAME }}
        MYSQL_USER=${{ secrets.DB_USER }}
        MYSQL_PASSWORD=${{ secrets.DB_PASSWORD }}
        REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
        EOL
          cd /home/ec2-user
          
          # 确保 Docker 正在运行
          if ! sudo docker ps &> /dev/null; then
            echo "启动 Docker 服务..."
            sudo systemctl start docker
            sleep 3
          fi
          
          # 使用完整路径确保命令可用（使用 sudo 因为可能需要权限）
          COMPOSE_CMD=$(command -v docker-compose 2>/dev/null || echo "/usr/local/bin/docker-compose")
          sudo $COMPOSE_CMD -f docker-compose.db.yml --env-file .env up -d
          sleep 15
          sudo $COMPOSE_CMD -f docker-compose.db.yml ps
        EOF
        
        echo "✅ Database server deployed"
    
    - name: Deploy application server
      run: |
        echo "=== Deploying Application Server ==="
        
        # 确保 Docker 和 Docker Compose 已安装并运行
        ssh -i ~/.ssh/lightsail-keypair.pem \
          -o StrictHostKeyChecking=no \
          ${{ env.SSH_USER }}@${{ secrets.APP_INSTANCE_IP }} << 'EOF'
          # 检查并安装 Docker
          if ! command -v docker &> /dev/null; then
            echo "安装 Docker..."
            sudo yum update -y
            sudo yum install -y docker
            sudo systemctl start docker
            sudo systemctl enable docker
            echo "✅ Docker 安装完成"
          else
            echo "✅ Docker 已安装"
            # 确保 Docker 服务正在运行
            sudo systemctl start docker || true
            sudo systemctl enable docker || true
          fi
          
          # 将 ec2-user 添加到 docker 组（避免需要使用 sudo）
          if ! groups | grep -q docker; then
            sudo usermod -aG docker ec2-user
            echo "⚠️  注意: 已添加到 docker 组，但需要重新登录才能生效"
          fi
          
          # 检查 Docker 是否运行
          if ! sudo docker ps &> /dev/null; then
            echo "启动 Docker 服务..."
            sudo systemctl start docker
            sleep 3
          fi
          
          # 验证 Docker 运行
          if sudo docker ps &> /dev/null; then
            echo "✅ Docker daemon 正在运行"
          else
            echo "❌ 错误: Docker daemon 未运行"
            sudo systemctl status docker
            exit 1
          fi
          
          # 检查并安装 Docker Compose
          if ! command -v docker-compose &> /dev/null && [ ! -f /usr/local/bin/docker-compose ]; then
            echo "安装 Docker Compose..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            echo "✅ Docker Compose 安装完成"
          else
            echo "✅ Docker Compose 已安装"
          fi
          
          # 验证 Docker Compose
          COMPOSE_CMD=$(command -v docker-compose 2>/dev/null || echo "/usr/local/bin/docker-compose")
          $COMPOSE_CMD version || sudo $COMPOSE_CMD version || echo "警告: 无法验证 Docker Compose 版本"
        EOF
        
        # Upload application configuration
        scp -i ~/.ssh/lightsail-keypair.pem \
          -o StrictHostKeyChecking=no \
          docker-compose.app.yml \
          ${{ env.SSH_USER }}@${{ secrets.APP_INSTANCE_IP }}:/home/ec2-user/
        
        # Upload backend WAR
        scp -i ~/.ssh/lightsail-keypair.pem \
          -o StrictHostKeyChecking=no \
          backend/target/app.war \
          ${{ env.SSH_USER }}@${{ secrets.APP_INSTANCE_IP }}:/home/ec2-user/backend.war
        
        # Upload frontend build
        scp -i ~/.ssh/lightsail-keypair.pem \
          -o StrictHostKeyChecking=no \
          -r frontend/build/* \
          ${{ env.SSH_USER }}@${{ secrets.APP_INSTANCE_IP }}:/home/ec2-user/frontend-build/
        
        # Create .env file and start services
        ssh -i ~/.ssh/lightsail-keypair.pem \
          -o StrictHostKeyChecking=no \
          ${{ env.SSH_USER }}@${{ secrets.APP_INSTANCE_IP }} << 'EOF'
          cat > /home/ec2-user/.env << EOL
        DB_HOST=${{ secrets.DB_INSTANCE_IP }}
        DB_PORT=3306
        DB_NAME=${{ secrets.DB_NAME }}
        DB_USER=${{ secrets.DB_USER }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        REDIS_HOST=${{ secrets.DB_INSTANCE_IP }}
        REDIS_PORT=6379
        REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
        EOL
          cd /home/ec2-user
          
          # 确保 Docker 正在运行
          if ! sudo docker ps &> /dev/null; then
            echo "启动 Docker 服务..."
            sudo systemctl start docker
            sleep 3
          fi
          
          # 使用完整路径确保命令可用（使用 sudo 因为可能需要权限）
          COMPOSE_CMD=$(command -v docker-compose 2>/dev/null || echo "/usr/local/bin/docker-compose")
          sudo $COMPOSE_CMD -f docker-compose.app.yml --env-file .env up -d --build
          sleep 20
          sudo $COMPOSE_CMD -f docker-compose.app.yml ps
        EOF
        
        echo "✅ Application server deployed"
    
    - name: Verify deployment
      run: |
        echo "=== Verifying Deployment ==="
        
        # 等待服务完全启动（增加等待时间）
        echo "等待服务启动（最多 2 分钟）..."
        MAX_WAIT=120
        WAIT_TIME=0
        HEALTH_CHECK_PASSED=false
        
        while [ $WAIT_TIME -lt $MAX_WAIT ]; do
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 --max-time 10 http://${{ secrets.APP_INSTANCE_IP }}/api/health 2>/dev/null || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "✅ Health check passed (HTTP $HTTP_STATUS)"
            HEALTH_CHECK_PASSED=true
            break
          else
            echo "  等待服务启动... (HTTP $HTTP_STATUS, ${WAIT_TIME}/${MAX_WAIT} 秒)"
            sleep 10
            WAIT_TIME=$((WAIT_TIME + 10))
          fi
        done
        
        if [ "$HEALTH_CHECK_PASSED" = false ]; then
          echo "⚠️  健康检查失败，检查容器状态..."
          ssh -i ~/.ssh/lightsail-keypair.pem \
            -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ secrets.APP_INSTANCE_IP }} << 'EOF'
            echo "=== 容器状态 ==="
            sudo docker ps -a
            echo ""
            echo "=== 后端容器日志 ==="
            sudo docker logs fullstack-backend --tail 50 || echo "无法获取后端日志"
            echo ""
            echo "=== Nginx 容器日志 ==="
            sudo docker logs fullstack-nginx --tail 50 || echo "无法获取 Nginx 日志"
            echo ""
            echo "=== 网络连接测试 ==="
            curl -v http://localhost:8080/api/health || echo "本地连接失败"
            curl -v http://localhost/api/health || echo "Nginx 代理失败"
          EOF
          exit 1
        fi
        
        # 等待几秒后测试 API
        sleep 5
        
        # Test API endpoint
        echo "测试 API 端点..."
        API_RESPONSE=$(curl -s --connect-timeout 5 --max-time 10 http://${{ secrets.APP_INSTANCE_IP }}/api/messages 2>/dev/null || echo "error")
        
        if echo "$API_RESPONSE" | grep -q "messages" || echo "$API_RESPONSE" | grep -q "\[\]"; then
          echo "✅ API test passed"
          echo "API 响应: ${API_RESPONSE:0:100}..."
        else
          echo "⚠️  API test failed"
          echo "API 响应: $API_RESPONSE"
          echo "检查数据库连接..."
          ssh -i ~/.ssh/lightsail-keypair.pem \
            -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ secrets.APP_INSTANCE_IP }} << 'EOF'
            echo "=== 后端日志（最后 30 行）==="
            sudo docker logs fullstack-backend --tail 30 || true
          EOF
          # 不退出，只警告（API 可能因为数据库连接问题失败）
          echo "⚠️  API 测试未通过，但继续完成部署"
        fi
    
    - name: Deployment summary
      run: |
        echo "=== Deployment Summary ==="
        echo "Application Server: http://${{ secrets.APP_INSTANCE_IP }}"
        echo "Database Server: ${{ secrets.DB_INSTANCE_IP }}"
        echo "✅ Deployment successful!"

