name: CI - Build and Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      run: |
        docker build -t hello-world-nginx:latest .
    
    - name: Run container and test
      run: |
        # å¯åŠ¨å®¹å™¨
        docker run -d -p 8080:80 --name test-container hello-world-nginx:latest
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 3
        
        # æµ‹è¯• HTTP å“åº”
        echo "=== æµ‹è¯• HTTP å“åº” ==="
        RESPONSE=$(curl -s http://localhost:8080)
        echo "$RESPONSE"
        
        # éªŒè¯è¾“å‡ºåŒ…å« "hello, world"
        if echo "$RESPONSE" | grep -q "hello, world"; then
          echo "âœ… æµ‹è¯•é€šè¿‡ï¼šè¾“å‡ºåŒ…å« 'hello, world'"
        else
          echo "âŒ æµ‹è¯•å¤±è´¥ï¼šè¾“å‡ºä¸åŒ…å« 'hello, world'"
          exit 1
        fi
        
        # éªŒè¯ HTTP çŠ¶æ€ç 
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080)
        if [ "$STATUS" -eq 200 ]; then
          echo "âœ… HTTP çŠ¶æ€ç : $STATUS"
        else
          echo "âŒ HTTP çŠ¶æ€ç : $STATUS (æœŸæœ› 200)"
          exit 1
        fi
        
        # æ¸…ç†
        docker stop test-container
        docker rm test-container
    
    - name: Image size check
      run: |
        IMAGE_SIZE=$(docker images hello-world-nginx:latest --format "{{.Size}}")
        echo "ğŸ“¦ Docker é•œåƒå¤§å°: $IMAGE_SIZE"
        echo "âœ… é•œåƒæ„å»ºæˆåŠŸ"


