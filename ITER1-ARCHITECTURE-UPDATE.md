# 架构更新：分离数据库方案

## 架构决策

**已选择**: 方案 2 - 分离数据库（中等成本）

## 架构设计

```
┌─────────────────────────────────┐
│  实例 1: 应用服务器              │
│  (Lightsail $3.50/月 或 EC2)    │
│  ┌───────────────────────────┐  │
│  │ Backend (Tomcat) 容器     │  │
│  │ - 内存限制: 512MB         │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │ Nginx 容器                │  │
│  │ - 内存限制: 128MB         │  │
│  └───────────────────────────┘  │
└─────────────────────────────────┘
           │
           │ 网络连接
           │ (3306, 6379)
           ▼
┌─────────────────────────────────┐
│  实例 2: 数据库服务器            │
│  (Lightsail $3.50/月 或 EC2)    │
│  ┌───────────────────────────┐  │
│  │ MySQL 5.7 容器            │  │
│  │ - 内存限制: 512MB         │  │
│  │ - 数据卷: mysql_data      │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │ Redis 7 容器              │  │
│  │ - 内存限制: 256MB         │  │
│  │ - 数据卷: redis_data      │  │
│  └───────────────────────────┘  │
└─────────────────────────────────┘
```

## 已创建的文件

1. **docker-compose.app.yml** - 应用服务器配置
   - Backend (Tomcat) 容器
   - Nginx 容器
   - 环境变量指向数据库服务器

2. **docker-compose.db.yml** - 数据库服务器配置
   - MySQL 5.7 容器
   - Redis 7 容器
   - 数据卷持久化

3. **ARCHITECTURE-SEPARATED.md** - 详细配置指南

4. **deploy/deploy-separated.sh** - 自动化部署脚本

## 成本分析

### 方案 A: 两个 Lightsail 实例（推荐）

| 组件 | 配置 | 月成本 |
|------|------|--------|
| 应用服务器 | Lightsail nano (512MB) | $3.50 |
| 数据库服务器 | Lightsail nano (512MB) | $3.50 |
| **总计** | | **$7.00** |

### 方案 B: EC2 免费层 + Lightsail（最省）

| 组件 | 配置 | 月成本 |
|------|------|--------|
| 应用服务器 | EC2 t3.micro 免费层 (1GB) | $0 |
| 数据库服务器 | Lightsail nano (512MB) | $3.50 |
| **总计** | | **$3.50** |

### 方案 C: 两个 EC2 免费层（如果可用）

| 组件 | 配置 | 月成本 |
|------|------|--------|
| 应用服务器 | EC2 t3.micro 免费层 | $0 |
| 数据库服务器 | EC2 t3.micro 免费层 | $0 |
| **总计** | | **$0** |

**注意**: EC2 免费层每月 750 小时，两个实例需要 1500 小时，超出免费额度。

## 资源分配

### 应用服务器（512MB 或 1GB）

```
总内存: 512MB (Lightsail) 或 1GB (EC2)
├── Backend (Tomcat): 512MB limit
├── Nginx: 128MB limit
└── 系统: 剩余
```

### 数据库服务器（512MB 或 1GB）

```
总内存: 512MB (Lightsail) 或 1GB (EC2)
├── MySQL: 512MB limit
├── Redis: 256MB limit
└── 系统: 剩余
```

## 安全配置

1. **防火墙规则**:
   - 数据库服务器：MySQL (3306) 和 Redis (6379) 仅允许应用服务器 IP
   - 应用服务器：HTTP (80) 和 HTTPS (443) 开放

2. **网络隔离**:
   - 使用私有 IP 通信（如果可能）
   - 或使用安全组限制访问

3. **密码管理**:
   - 使用环境变量
   - 不在代码中硬编码

## 部署流程

1. 创建两个实例（应用服务器和数据库服务器）
2. 在数据库服务器部署 MySQL + Redis
3. 配置防火墙规则
4. 在应用服务器部署 Backend + Nginx
5. 配置环境变量指向数据库服务器
6. 验证连接和功能

## 优势

✅ **性能隔离**: 数据库和应用不竞争资源  
✅ **独立扩展**: 可以单独升级数据库服务器  
✅ **更好的安全性**: 数据库端口可以限制访问  
✅ **数据持久化**: 数据库实例可以独立备份  
✅ **符合成本目标**: $7/月（在 $5-20/月预算内）

## 下一步

进入**迭代 2**: 完善 GitHub Actions CI（需要更新以支持分离架构）


